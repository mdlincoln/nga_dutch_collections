require "parallel"
require "ruby-progressbar"
load "scrape/scraper.rb"

BASEURL = "http://www.nga.gov"
SYSCAT = "/content/ngaweb/research/online-editions/17th-century-dutch-paintings.html"

task :default => :retrieve

task :retrieve => "scrape/html" do
  # Get all object links
  links = object_url_list("#{BASEURL}#{SYSCAT}")
  
  # Run load_file process for each file in parallel
  prog_bar = ProgressBar.create(:title => "Files imported", :starting_at => 0, :total => links.count, :format => '%c |%b>>%i| %p%%') # => Create a progress bar

  Parallel.map_with_index(links, :in_processes => 8, :finish => lambda { |item, i, result| prog_bar.increment }) do |object_url|
    url = "#{BASEURL}#{object_url}"
    filename = "scrape/html" + object_url.match(/\/content\/ngaweb\/Collection\/(.*)$/)[0]
    download_content(url, filename)
  end
end

directory "scrape/html"
